<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Examen de Ciudadan√≠a Mexicana - Pr√°ctica</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/common.css') }}">
    <style>
        /* Quiz-specific styles */
        h1 {
            color: #005a31;
            margin-bottom: 25px;
        }
        .question {
            font-size: 1.25em;
            margin-bottom: 25px;
            min-height: 50px;
        }
        .options {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        .option-btn {
            background-color: #f8f9fa;
            border: 2px solid #ced4da;
            border-radius: 8px;
            padding: 15px;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            text-align: left;
        }
        .option-btn:hover:not(:disabled) {
            border-color: #005a31;
            background-color: #e8f5e9;
        }
        .option-btn.correct {
            background-color: #28a745;
            border-color: #28a745;
            color: white;
            font-weight: bold;
        }
        .option-btn.incorrect {
            background-color: #dc3545;
            border-color: #dc3545;
            color: white;
        }
        .option-btn:disabled {
            cursor: not-allowed;
        }
        .next-btn.visible {
            visibility: visible;
        }
    </style>
</head>
<body>
    <!-- Main Menu Bar -->
    <div class="menu-bar">
        <div class="menu-left">
            <a href="/synopsis" class="menu-nav-link">üìñ Sinopsis</a>
            <span class="menu-separator">|</span>
            <a href="/" class="menu-nav-link active">üìù Preguntas</a>
            <span class="menu-separator">|</span>
            <a href="/geography_states" class="menu-nav-link">üó∫Ô∏è Geograf√≠a</a>
        </div>
        <div class="menu-right">
            <div class="menu-item">
                <label for="speech-rate">Velocidad:</label>
                <select id="speech-rate">
                    <option value="0.7">Lenta</option>
                    <option value="1.0" selected>Normal</option>
                    <option value="1.2">R√°pida</option>
                </select>
            </div>
            <div class="menu-item">
                <button id="menu-speech-toggle" class="menu-toggle">üîä Audio: ON</button>
            </div>
            <div class="menu-item">
                <button id="delete-question-btn" class="menu-toggle" style="background-color: #dc3545; border-color: #dc3545;" title="Eliminar esta pregunta de la base de datos">üóëÔ∏è Eliminar</button>
            </div>
        </div>
    </div>

    <!-- Sub Menu Bar (Preguntas Section) -->
    <div class="submenu-bar">
        <a href="/" class="submenu-nav-link active">Opci√≥n M√∫ltiple</a>
        <span class="submenu-separator">|</span>
        <a href="/multiline" class="submenu-nav-link">Listas</a>
    </div>

    <div class="quiz-container">
        <h1>Prueba de Pr√°ctica</h1>

        <!-- Progress indicator -->
        <div class="progress-container" style="margin-bottom: 20px; padding: 15px; background-color: #f8f9fa; border-radius: 8px; border: 1px solid #dee2e6;">
            <div style="font-size: 0.9em; color: #495057;">
                Preguntas Dominadas: {{ mastered_count }} |
                Preguntas en Sesi√≥n: {{ total_in_set }} |
                Preguntas Totales: {{ total_questions }}
            </div>
        </div>

        <div style="display: flex; align-items: center; justify-content: center; gap: 15px; margin-bottom: 25px;">
            <div id="question" class="question" style="margin-bottom: 0; min-height: 50px; flex: 1;">{{ question }}</div>
            <button id="replay-speech" style="background: none; border: 2px solid #005a31; border-radius: 50%; width: 40px; height: 40px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 16px;" title="Repetir pregunta">
                üîä
            </button>
            <button id="translate-btn" style="background: none; border: 2px solid #005a31; border-radius: 50%; width: 40px; height: 40px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 16px;" title="Traducir en Google">
                üåê
            </button>
        </div>

        <div class="options">
            {% for option in options %}
                <button class="option-btn">{{ option }}</button>
            {% endfor %}
        </div>

        <!-- This hidden div holds the correct answer for our JavaScript to check against -->
        <div id="correct-answer" style="display: none;">{{ correct_answer }}</div>
        <div id="question-id" style="display: none;">{{ question_id }}</div>
        <div id="notes" style="display: none;">{{ notes if notes else '' }}</div>

        <!-- Notes display area (shown after answer is revealed) -->
        <div id="notes-display" style="display: none; margin-top: 20px; padding: 15px; background-color: #e8f5e9; border-left: 4px solid #005a31; border-radius: 4px;">
            <strong style="color: #005a31;">Nota:</strong>
            <span id="notes-text"></span>
        </div>

        <a href="#" id="next-btn" class="next-btn">Siguiente Pregunta</a>
    </div>

    <!-- Shared speech functionality -->
    <script src="/static/speech.js"></script>

    <script>
        // Page-specific speech functions
        function speakQuestion() {
            const questionText = document.getElementById('question').textContent;
            speakText(questionText);
        }

        function displayNotes() {
            const notes = document.getElementById('notes').textContent.trim();
            if (notes) {
                const notesDisplay = document.getElementById('notes-display');
                const notesText = document.getElementById('notes-text');
                notesText.textContent = notes;
                notesDisplay.style.display = 'block';
                return notes;
            }
            return null;
        }

        document.addEventListener('DOMContentLoaded', () => {
            const optionsContainer = document.querySelector('.options');
            const correctAnswer = document.getElementById('correct-answer').textContent.trim();
            const questionId = document.getElementById('question-id').textContent.trim();
            const nextButton = document.getElementById('next-btn');

            // Debug: Log the current question ID
            console.log('Current question ID:', questionId);
            const menuSpeechToggle = document.getElementById('menu-speech-toggle');
            const speechRateSelect = document.getElementById('speech-rate');
            const replayButton = document.getElementById('replay-speech');
            const deleteButton = document.getElementById('delete-question-btn');
            const geographyLink = document.getElementById('geography-link');

            // Replay speech functionality
            replayButton.addEventListener('click', speakQuestion);

            // Translate button functionality
            const translateButton = document.getElementById('translate-btn');
            translateButton.addEventListener('click', () => {
                const questionText = document.getElementById('question').textContent;
                const encodedText = encodeURIComponent(questionText);
                const translateUrl = `https://translate.google.com/?sl=es&tl=en&text=${encodedText}&op=translate`;
                window.open(translateUrl, '_blank');
            });

            // Navigation links - stop speech before navigating
            document.querySelectorAll('.menu-nav-link').forEach(link => {
                link.addEventListener('click', () => {
                    speechSynthesis.cancel();
                });
            });

            // Next button functionality
            nextButton.addEventListener('click', (e) => {
                e.preventDefault();
                window.location.href = '/';
            });

            // Delete question functionality
            deleteButton.addEventListener('click', async () => {
                if (confirm('¬øEst√°s seguro de que quieres eliminar esta pregunta de la base de datos? Esta acci√≥n no se puede deshacer.')) {
                    try {
                        deleteButton.disabled = true;
                        deleteButton.textContent = '‚è≥ Eliminando...';

                        const response = await fetch('/delete_question', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                question_id: parseInt(questionId)
                            })
                        });

                        const result = await response.json();

                        if (result.success) {
                            alert('Pregunta eliminada exitosamente.');
                            window.location.href = '/'; // Load next question
                        } else {
                            alert('Error al eliminar la pregunta: ' + result.error);
                            deleteButton.disabled = false;
                            deleteButton.textContent = 'üóëÔ∏è Eliminar';
                        }
                    } catch (error) {
                        console.error('Error deleting question:', error);
                        alert('Error al eliminar la pregunta. Por favor, intenta de nuevo.');
                        deleteButton.disabled = false;
                        deleteButton.textContent = 'üóëÔ∏è Eliminar';
                    }
                }
            });

            // Auto-speak question when page loads (if enabled)
            setTimeout(() => {
                if (speechEnabled) {
                    speakQuestion();
                }
            }, 500); // Small delay to ensure page is fully loaded

            optionsContainer.addEventListener('click', async (event) => {
                // Check if the clicked element is an option button and is not disabled
                if (event.target.classList.contains('option-btn') && !event.target.disabled) {
                    const selectedOption = event.target;
                    const allOptions = optionsContainer.querySelectorAll('.option-btn');
                    const selectedAnswer = selectedOption.textContent;

                    // Disable all buttons to prevent multiple answers
                    allOptions.forEach(btn => {
                        btn.disabled = true;
                    });

                    // Check if "No s√©" was selected (just reveal answer, don't track)
                    if (selectedAnswer === "No s√©") {
                        // Don't mark "No s√©" as incorrect, just highlight the correct answer
                        allOptions.forEach(btn => {
                            if (btn.textContent === correctAnswer) {
                                btn.classList.add('correct');
                            }
                        });

                        // Display notes if they exist
                        const notes = displayNotes();

                        // Speak the correct answer without "incorrect" prefix, then notes if they exist
                        setTimeout(() => {
                            const fullText = notes
                                ? `La respuesta correcta es: ${correctAnswer}. Nota: ${notes}`
                                : `La respuesta correcta es: ${correctAnswer}`;

                            speakText(fullText, () => {
                                // Auto-advance after speech completes
                                setTimeout(() => {
                                    window.location.href = '/';
                                }, 1000); // 1 second delay after speech
                            });
                        }, 300);
                        // Don't send to server for tracking - "No s√©" is neutral
                    } else {
                        // Check if the selected answer is correct
                        const isCorrect = selectedAnswer === correctAnswer;
                        if (isCorrect) {
                            selectedOption.classList.add('correct');

                            // Display notes if they exist
                            const notes = displayNotes();

                            // Speak "Correcto" followed by the correct answer and notes if they exist
                            setTimeout(() => {
                                const fullText = notes
                                    ? `Correcto. ${correctAnswer}. Nota: ${notes}`
                                    : `Correcto. ${correctAnswer}`;

                                speakText(fullText, () => {
                                    // Auto-advance after speech completes
                                    setTimeout(() => {
                                        window.location.href = '/';
                                    }, 1000); // 1 second delay after speech
                                });
                            }, 300);
                        } else {
                            selectedOption.classList.add('incorrect');
                            // Highlight the correct answer anyway so the user can learn
                            allOptions.forEach(btn => {
                                if (btn.textContent === correctAnswer) {
                                    btn.classList.add('correct');
                                }
                            });

                            // Display notes if they exist
                            const notes = displayNotes();

                            // Speak the correct answer and notes if they exist
                            setTimeout(() => {
                                const fullText = notes
                                    ? `La respuesta correcta es: ${correctAnswer}. Nota: ${notes}`
                                    : `La respuesta correcta es: ${correctAnswer}`;

                                speakText(fullText, () => {
                                    // Auto-advance after speech completes
                                    setTimeout(() => {
                                        window.location.href = '/';
                                    }, 1000); // 1 second delay after speech
                                });
                            }, 300);
                        }

                        // Send answer to server for tracking (only for actual attempts)
                        // Fire and forget - don't block on this
                        fetch('/answer', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                question_id: parseInt(questionId),
                                selected_answer: selectedAnswer,
                                correct_answer: correctAnswer
                            })
                        }).catch(error => console.error('Error recording answer:', error));
                    }

                    // Show the "Next Question" button immediately
                    nextButton.style.visibility = 'visible';

                    // If speech is disabled, auto-advance after 2 seconds
                    if (!speechEnabled) {
                        setTimeout(() => {
                            window.location.href = '/';
                        }, 2000);
                    }
                }
            });
        });
    </script>
</body>
</html>